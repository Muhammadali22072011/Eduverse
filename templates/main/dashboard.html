{% extends "base.html" %}

{% block title %}Панель управления - EduVerse{% endblock %}

{% block content %}
<!-- Welcome Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 bg-gradient text-white" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <div class="card-body p-4">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h2 class="mb-2">
                            <i class="fas fa-sun me-2"></i>
                            Добро пожаловать, {{ current_user.get_full_name() }}!
                        </h2>
                        <p class="mb-0 opacity-75">
                            {% if primary_role %}
                                Ваша роль: <strong>{{ primary_role.role.description }}</strong>
                            {% else %}
                                Добро пожаловать в EduVerse!
                            {% endif %}
                        </p>
                    </div>
                    <div class="col-md-4 text-md-end">
                        <div class="text-end">
                            <div class="h4 mb-0">{{ current_user.username }}</div>
                            <small class="opacity-75">{{ current_user.email }}</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Stats -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card dashboard-card success h-100">
            <div class="card-body text-center">
                <i class="fas fa-school fa-2x mb-3 opacity-75"></i>
                <h3>{{ user_schools|length }}</h3>
                <p>Мои школы</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card dashboard-card info h-100">
            <div class="card-body text-center">
                <i class="fas fa-bell fa-2x mb-3 opacity-75"></i>
                <h3>{{ notifications|length }}</h3>
                <p>Уведомления</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card dashboard-card warning h-100">
            <div class="card-body text-center">
                <i class="fas fa-comments fa-2x mb-3 opacity-75"></i>
                <h3>{{ recent_messages|length }}</h3>
                <p>Сообщения</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card dashboard-card h-100">
            <div class="card-body text-center">
                <i class="fas fa-calendar-alt fa-2x mb-3 opacity-75"></i>
                <h3 id="today-events">0</h3>
                <p>События сегодня</p>
            </div>
        </div>
    </div>
</div>

<!-- Main Content -->
<div class="row">
    <!-- Left Column -->
    <div class="col-lg-8">
        <!-- Schools Section -->
        {% if user_schools %}
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-school me-2"></i>Мои школы
                </h5>
                <a href="{{ url_for('school.schools_list') }}" class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-plus me-1"></i>Добавить школу
                </a>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for school in user_schools %}
                    <div class="col-md-6 mb-3">
                        <div class="card school-card h-100 border">
                            <div class="card-body">
                                <div class="d-flex align-items-center mb-3">
                                    {% if school.logo %}
                                    <img src="{{ url_for('static', filename='uploads/' + school.logo) }}" 
                                         alt="{{ school.name }}" class="school-logo me-3">
                                    {% else %}
                                    <div class="school-logo bg-secondary d-flex align-items-center justify-content-center me-3">
                                        <i class="fas fa-school text-white"></i>
                                    </div>
                                    {% endif %}
                                    <div>
                                        <h6 class="mb-1">{{ school.name }}</h6>
                                        <small class="text-muted">
                                            {% if school.is_verified %}
                                                <span class="badge bg-success">Верифицирована</span>
                                            {% else %}
                                                <span class="badge bg-warning">Ожидает верификации</span>
                                            {% endif %}
                                        </small>
                                    </div>
                                </div>
                                
                                <div class="d-grid gap-2">
                                    <a href="{{ url_for('school.school_view', slug=school.slug) }}" 
                                       class="btn btn-outline-primary btn-sm">
                                        <i class="fas fa-eye me-1"></i>Просмотр
                                    </a>
                                    {% if current_user.has_role('school_admin') or current_user.has_role('super_admin') %}
                                    <a href="{{ url_for('school.school_admin', slug=school.slug) }}" 
                                       class="btn btn-outline-secondary btn-sm">
                                        <i class="fas fa-cog me-1"></i>Управление
                                    </a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Role-specific Content -->
        {% if primary_role and primary_role.role.name == 'student' %}
            <!-- Student Dashboard -->
            {% include 'dashboard/student_dashboard.html' %}
        {% elif primary_role and primary_role.role.name == 'teacher' %}
            <!-- Teacher Dashboard -->
            {% include 'dashboard/teacher_dashboard.html' %}
        {% elif primary_role and primary_role.role.name == 'school_admin' %}
            <!-- School Admin Dashboard -->
            {% include 'dashboard/school_admin_dashboard.html' %}
        {% elif primary_role and primary_role.role.name == 'super_admin' %}
            <!-- Super Admin Dashboard -->
            {% include 'dashboard/super_admin_dashboard.html' %}
        {% endif %}
    </div>

    <!-- Right Column -->
    <div class="col-lg-4">
        <!-- Notifications -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-bell me-2"></i>Уведомления
                </h6>
            </div>
            <div class="card-body p-0">
                {% if notifications %}
                    <div class="list-group list-group-flush">
                        {% for notification in notifications %}
                        <div class="list-group-item border-0 py-3 {% if not notification.is_read %}unread{% endif %}">
                            <div class="d-flex align-items-start">
                                <div class="flex-shrink-0 me-3">
                                    <i class="{{ notification.get_icon_class() }} text-{{ notification.get_priority_class() }}"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <h6 class="mb-1">{{ notification.title }}</h6>
                                    <p class="mb-1 small">{{ notification.message }}</p>
                                    <small class="text-muted">{{ notification.get_time_ago() }}</small>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="card-footer text-center">
                        <a href="#" class="btn btn-sm btn-outline-primary">Все уведомления</a>
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-bell-slash fa-2x text-muted mb-3"></i>
                        <p class="text-muted mb-0">Нет новых уведомлений</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Recent Messages -->
        {% if recent_messages %}
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-comments me-2"></i>Последние сообщения
                </h6>
            </div>
            <div class="card-body p-0">
                <div class="list-group list-group-flush">
                    {% for message in recent_messages[:5] %}
                    <div class="list-group-item border-0 py-2">
                        <div class="d-flex align-items-start">
                            <div class="flex-shrink-0 me-2">
                                <i class="fas fa-user-circle text-muted"></i>
                            </div>
                            <div class="flex-grow-1">
                                <div class="d-flex justify-content-between align-items-start">
                                    <strong class="small">{{ message.sender.username }}</strong>
                                    <small class="text-muted">{{ message.created_at.strftime('%H:%M') }}</small>
                                </div>
                                <p class="mb-0 small text-truncate">{{ message.content }}</p>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <div class="card-footer text-center">
                    <a href="{{ url_for('chat.chat_list') }}" class="btn btn-sm btn-outline-primary">Все чаты</a>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Quick Actions -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-bolt me-2"></i>Быстрые действия
                </h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ url_for('chat.chat_create') }}" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-plus me-1"></i>Создать чат
                    </a>
                    {% if current_user.has_role('super_admin') or current_user.has_role('project_admin') %}
                    <a href="{{ url_for('school.school_create') }}" class="btn btn-outline-success btn-sm">
                        <i class="fas fa-school me-1"></i>Создать школу
                    </a>
                    {% endif %}
                    <a href="{{ url_for('auth.profile') }}" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-user me-1"></i>Мой профиль
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Update today's events count
function updateTodayEvents() {
    const today = new Date();
    const dayOfWeek = today.getDay();
    
    // This would typically fetch from API
    // For now, just show a placeholder
    document.getElementById('today-events').textContent = '0';
}

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    updateTodayEvents();
    
    // Update every 5 minutes
    setInterval(updateTodayEvents, 300000);
});
</script>
{% endblock %}